<%-
  groups = OodSupport::User.new.groups.sort_by(&:id).tap { |groups|
    groups.unshift(groups.delete(OodSupport::Process.group))
  }.map(&:name).grep(/.*[0-9]{5}/)
-%>
---
cluster: "my-k8s-cluster"
title: "ANSYS Workbench"
description: |
  This app will launch ANSYS Workbench.
attributes:
  bc_vnc_resolution:
    required: true
  account:
    label: Project Code
    widget: select
    options: 
      <%- groups.each do |group| %>
      - "<%= group %>"
      <%- end %>
    required: true
  bc_num_hours:
    max: 24
    min: 1
    step: 1
    value: 1
    widget: number_field
  num_cores:
    label: Number of cores
    max: 4
    min: 1
    value: 2
    widget: number_field
  num_mem:
    label: Memory per job (GB)
    max: 32
    min: 2
    step: 1
    value: 2
    widget: number_field
  ansysver:
    widget: select
    label: "ANSYS Version"
    required: true
    options:
    <%- 
      # Get available modules dynamically from LMOD paths
      begin
        module_path =  "/opt/nesi/lmod/mahuika/ANSYS"
        available_modules = []
        Dir.glob("#{module_path}/*.lua").each do |file|
          # Extract module name from file path
          relative_path = file.sub("#{module_path}/", "")
          module_name = relative_path.sub(/\.lua$/, "")                
          available_modules << module_name
        end
        
        # Sort modules and create options
        available_modules.uniq.sort.each do |mod|
          # Create a friendly display name
          display_name = mod.include?('/') ? "#{mod.split('/').first}/#{mod.split('/').last}" : mod
      -%>
      - ["<%= display_name %>", "<%= mod %>"]
      <%- 
        end
      end
      -%>
  ansyslic:
    widget: select
    label: "Licence"
    required: true
    options:
    <%- 
      # Get available licences dynamically from licence path
      begin
        lic_base_path =  "/opt/nesi/share/ANSYS/Licenses"
        all_lic = []
        Dir.glob("#{lic_base_path}/*.lic").each do |lic_path|
          Pathname.new("lic_path")
          all_lic << lic_path
        end
        all_lic.each do |lic_path|
          lic_name = "#{lic_path.split('/').last.split('.').first}"
          -%>
            - ["<%= lic_name %>", "<%= lic_path %>"]
          <%- 
        end
      -%>
    help:<%- 
      if all_lic.empty?
      -%>
      "YOU DO NOT HAVE ACCESS TO A VALID ANSYS LICENCE"
      <%-
      else
      -%>
      "Select which licence to use."
      <%-
      end
    end
    -%>
form:
  - account
  - bc_vnc_resolution
  - bc_num_hours
  - num_cores
  - num_mem
  - ansysver
  - ansyslic
